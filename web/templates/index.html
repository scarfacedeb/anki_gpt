<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>Anki GPT - Word Viewer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Prevent flash of white background */
        html {
            background-color: #f8f9fa;
        }
        @media (prefers-color-scheme: dark) {
            html {
                background-color: #0f172a;
            }
        }
        html.dark-mode {
            background-color: #0f172a;
        }
    </style>
    <script>
        // Apply theme immediately to prevent flash - must run before any rendering
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (savedTheme !== 'light' && prefersDark)) {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <div class="header-left">
            <h1>üìö Anki GPT - Word Viewer</h1>
            <div class="stats">
                Total words: {{ stats.total_words }} |
                Synced to Anki: {{ stats.synced_to_anki }} |
                Unsynced: {{ stats.unsynced }}
                {% if showing_count > 0 %}
                | Showing {{ showing_start }}-{{ showing_end }} of {{ total_words }}
                {% endif %}
            </div>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="theme-toggle" onclick="syncAnki()" id="syncButton">üîÑ Sync Anki</button>
            <button class="theme-toggle" onclick="toggleTheme()">üåô Dark Mode</button>
        </div>
    </header>

    <div class="search-sort-wrapper">
        <form method="GET" action="/" class="search-box">
            <input
                type="text"
                name="q"
                placeholder="Search for Dutch words, translations, or definitions..."
                value="{{ query or '' }}"
            >
            <button type="submit">Search</button>
        </form>

        <div class="quick-add-container">
            <input
                type="text"
                id="quickAddInput"
                placeholder="Add new word..."
                onkeypress="if(event.key === 'Enter') quickAddWord()"
            >
            <button onclick="quickAddWord()" class="btn btn-add">+</button>
        </div>

        <div class="sort-controls">
            <label>Sort:</label>
            <select id="sort-combined" onchange="updateSort()">
                <option value="created_at-desc" {% if sort_by == 'created_at' and order == 'desc' %}selected{% endif %}>Newest First</option>
                <option value="created_at-asc" {% if sort_by == 'created_at' and order == 'asc' %}selected{% endif %}>Oldest First</option>
                <option value="dutch-asc" {% if sort_by == 'dutch' and order == 'asc' %}selected{% endif %}>Dutch (A ‚Üí Z)</option>
                <option value="dutch-desc" {% if sort_by == 'dutch' and order == 'desc' %}selected{% endif %}>Dutch (Z ‚Üí A)</option>
                <option value="translation-asc" {% if sort_by == 'translation' and order == 'asc' %}selected{% endif %}>Translation (A ‚Üí Z)</option>
                <option value="translation-desc" {% if sort_by == 'translation' and order == 'desc' %}selected{% endif %}>Translation (Z ‚Üí A)</option>
                <option value="grammar-asc" {% if sort_by == 'grammar' and order == 'asc' %}selected{% endif %}>Grammar (A ‚Üí Z)</option>
                <option value="grammar-desc" {% if sort_by == 'grammar' and order == 'desc' %}selected{% endif %}>Grammar (Z ‚Üí A)</option>
            </select>
        </div>
    </div>

    <div id="quickAddFeedback" class="quick-add-feedback"></div>

    {% if words_data %}
    <!-- Pagination Top (only show from page 2 onwards) -->
    {% if total_pages > 1 and page > 1 %}
    <div class="pagination-container">
        <div class="pagination">
            {% if page > 1 %}
                <a href="?{{ get_pagination_url(page - 1, query, sort_by, order) }}" class="pagination-btn">‚Üê Prev</a>
            {% else %}
                <span class="pagination-btn disabled">‚Üê Prev</span>
            {% endif %}

            {% for p in page_range %}
                {% if p == '...' %}
                    <span class="pagination-ellipsis">...</span>
                {% elif p == page %}
                    <span class="pagination-btn active">{{ p }}</span>
                {% else %}
                    <a href="?{{ get_pagination_url(p, query, sort_by, order) }}" class="pagination-btn">{{ p }}</a>
                {% endif %}
            {% endfor %}

            {% if page < total_pages %}
                <a href="?{{ get_pagination_url(page + 1, query, sort_by, order) }}" class="pagination-btn">Next ‚Üí</a>
            {% else %}
                <span class="pagination-btn disabled">Next ‚Üí</span>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="word-list">
        {% for word, created_at, updated_at, anki_info in words_data %}
        <div class="word-card">
            <div class="word-summary" onclick="toggleDetails(this)">
                <div class="word-dutch">
                    {{ word.dutch }}
                    {% if not anki_info.synced %}
                        <span style="font-size: 11px; color: #f59e0b; margin-left: 6px;">‚ö† Not synced</span>
                    {% endif %}
                    <div style="font-size: 11px; color: var(--text-dim); font-weight: normal; margin-top: 2px;">
                        {{ updated_at[:10] if updated_at else '' }}
                    </div>
                </div>
                <div class="word-translation">{{ word.translation }}</div>
                <div class="word-grammar-pronunciation">
                    <div class="word-grammar">{{ word.grammar[:60] }}{% if word.grammar|length > 60 %}...{% endif %}</div>
                    <div class="word-pronunciation">{{ word.pronunciation }}</div>
                </div>
                <div class="word-preview">{{ word.definition_nl[:80] }}...</div>
            </div>

            <div class="word-details">
                <div class="word-section">
                    <div class="word-label">Grammar</div>
                    <div class="word-content">{{ word.grammar }}</div>
                </div>

                <div class="word-section">
                    <div class="word-label">Definition (NL)</div>
                    <div class="word-content">{{ word.definition_nl }}</div>
                </div>

                <div class="word-section">
                    <div class="word-label">Definition (EN)</div>
                    <div class="word-content">{{ word.definition_en }}</div>
                </div>

                {% if word.collocations %}
                <div class="word-section">
                    <div class="word-label">Collocations</div>
                    <div class="word-list-inline">{{ word.collocations | join(', ') }}</div>
                </div>
                {% endif %}

                {% if word.synonyms %}
                <div class="word-section">
                    <div class="word-label">Synonyms</div>
                    <div class="word-list-inline">{{ word.synonyms | join(', ') }}</div>
                </div>
                {% endif %}

                {% if word.related %}
                <div class="word-section">
                    <div class="word-label">Related Words</div>
                    <div class="word-list-inline">{{ word.related | join(', ') }}</div>
                </div>
                {% endif %}

                {% if word.examples_nl %}
                <div class="word-section">
                    <div class="word-label">Examples</div>
                    <div class="examples">
                        {% for nl, en in zip(word.examples_nl, word.examples_en) %}
                        <div class="example-item">
                            <div class="example-nl">{{ nl }}</div>
                            <div class="example-en">{{ en }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if word.etymology %}
                <div class="word-section">
                    <div class="word-label">Etymology</div>
                    <div class="word-content">{{ word.etymology }}</div>
                </div>
                {% endif %}

                <div class="word-section">
                    <div class="word-label">Anki Sync Info</div>
                    <div class="word-content">
                        {% if anki_info.synced %}
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 16px; font-size: 13px;">
                                <span style="color: var(--text-dim);">Status:</span>
                                <span style="color: #10b981; font-weight: 500;">‚úì Synced to Anki</span>

                                <span style="color: var(--text-dim);">Deck:</span>
                                <span>{{ anki_info.deck_name or 'Default' }}</span>

                                {% if anki_info.synced_at %}
                                <span style="color: var(--text-dim);">Last synced:</span>
                                <span>{{ anki_info.synced_at[:19] }}</span>
                                {% endif %}

                                {% if anki_info.sync_count %}
                                <span style="color: var(--text-dim);">Sync count:</span>
                                <span>{{ anki_info.sync_count }}</span>
                                {% endif %}

                                {% if anki_info.reviews is not none %}
                                <span style="color: var(--text-dim);">Reviews:</span>
                                <span>{{ anki_info.reviews }}</span>
                                {% endif %}

                                {% if anki_info.lapses is not none %}
                                <span style="color: var(--text-dim);">Lapses:</span>
                                <span>{{ anki_info.lapses }}</span>
                                {% endif %}

                                {% if anki_info.ease_factor is not none %}
                                <span style="color: var(--text-dim);">Ease factor:</span>
                                <span>{{ (anki_info.ease_factor / 10)|round(1) }}%</span>
                                {% endif %}

                                {% if anki_info.interval is not none %}
                                <span style="color: var(--text-dim);">Interval:</span>
                                <span>{{ anki_info.interval }} days</span>
                                {% endif %}

                                {% if anki_info.due is not none %}
                                <span style="color: var(--text-dim);">Next review:</span>
                                <span>{{ anki_info.due }}</span>
                                {% endif %}
                            </div>
                        {% else %}
                            <span style="color: #f59e0b;">‚ö† Not synced to Anki</span>
                        {% endif %}
                    </div>
                </div>

                <div class="word-actions">
                    <button class="btn btn-regenerate" onclick="event.stopPropagation(); regenerateWord('{{ word.dutch | replace("'", "\\'") }}', this.closest('.word-card'))">üîÑ Regenerate</button>
                    <a href="/edit/{{ word.dutch | urlencode }}" class="btn btn-edit" onclick="event.stopPropagation()">Edit</a>
                    <button class="btn btn-delete" onclick="event.stopPropagation(); deleteWord('{{ word.dutch | replace("'", "\\'") }}', this.closest('.word-card'))">Delete</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination Bottom -->
    {% if total_pages > 1 %}
    <div class="pagination bottom">
        {% if page > 1 %}
            <a href="?{{ get_pagination_url(page - 1, query, sort_by, order) }}" class="pagination-btn">‚Üê Prev</a>
        {% else %}
            <span class="pagination-btn disabled">‚Üê Prev</span>
        {% endif %}

        {% for p in page_range %}
            {% if p == '...' %}
                <span class="pagination-ellipsis">...</span>
            {% elif p == page %}
                <span class="pagination-btn active">{{ p }}</span>
            {% else %}
                <a href="?{{ get_pagination_url(p, query, sort_by, order) }}" class="pagination-btn">{{ p }}</a>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
            <a href="?{{ get_pagination_url(page + 1, query, sort_by, order) }}" class="pagination-btn">Next ‚Üí</a>
        {% else %}
            <span class="pagination-btn disabled">Next ‚Üí</span>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="no-results">
        {% if query %}
            No words found for "{{ query }}"
        {% else %}
            No words in database yet. Add some words using the CLI!
        {% endif %}
    </div>
    {% endif %}

    <!-- Regenerate Modal -->
    <div id="regenerateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Review Regenerated Word</h2>
                <button class="modal-close" onclick="closeRegenerateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="regenerate-loading" id="regenerateLoading">
                    <div class="spinner"></div>
                    <p>Regenerating word with ChatGPT...</p>
                </div>
                <div class="regenerate-comparison" id="regenerateComparison" style="display: none;">
                    <div class="comparison-column">
                        <h3>Current Version</h3>
                        <div id="currentVersion"></div>
                    </div>
                    <div class="comparison-column">
                        <h3>New Version</h3>
                        <div id="newVersion"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="modalFooter" style="display: none;">
                <button class="btn btn-secondary" onclick="closeRegenerateModal()">Decline</button>
                <button class="btn btn-primary" onclick="confirmRegeneratedWord()">Confirm & Save</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        function updateSort() {
            const combined = document.getElementById('sort-combined').value;
            const [sortBy, order] = combined.split('-');
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('sort', sortBy);
            urlParams.set('order', order);
            urlParams.delete('page');  // Reset to page 1 when sorting changes
            window.location.search = urlParams.toString();
        }

        async function syncAnki() {
            const btn = document.getElementById('syncButton');
            const originalText = btn.textContent;

            btn.disabled = true;
            btn.textContent = '‚è≥ Starting...';

            try {
                // Start sync
                const response = await fetch('/api/sync', {
                    method: 'POST'
                });

                const data = await response.json();

                if (!data.success) {
                    btn.textContent = '‚ùå Failed';
                    console.error('Sync failed:', data.error);
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                    return;
                }

                // Sync started - poll for status
                btn.textContent = '‚è≥ Syncing...';
                pollSyncStatus(btn, originalText);

            } catch (error) {
                console.error('Sync error:', error);
                btn.textContent = '‚ùå Error';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        async function pollSyncStatus(btn, originalText) {
            try {
                const response = await fetch('/api/sync/status');
                const status = await response.json();

                if (status.in_progress) {
                    // Still syncing - check again in 1 second
                    setTimeout(() => pollSyncStatus(btn, originalText), 1000);
                } else if (status.last_result) {
                    // Sync completed
                    const result = status.last_result;

                    if (result.success) {
                        const message = `‚úÖ ${result.synced}/${result.total}`;
                        btn.textContent = message;

                        if (result.failed > 0) {
                            console.warn(`${result.failed} words failed to sync`);
                        }

                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.disabled = false;
                            // Reload page to show updated sync stats
                            window.location.reload();
                        }, 2000);
                    } else {
                        btn.textContent = '‚ùå Failed';
                        console.error('Sync failed:', result.error);
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.disabled = false;
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error('Status polling error:', error);
                btn.textContent = '‚ùå Error';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }
    </script>
</body>
</html>
