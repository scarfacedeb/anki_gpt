<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anki GPT - Word Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        // Apply theme immediately to prevent flash
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (savedTheme !== 'light' && prefersDark)) {
                document.documentElement.classList.add('dark-mode');
            }
        })();
    </script>
</head>
<body>
    <header>
        <div class="header-left">
            <h1>üìö Anki GPT - Word Viewer</h1>
            <div class="stats">
                Total words: {{ stats.total_words }} |
                Synced to Anki: {{ stats.synced_to_anki }} |
                Unsynced: {{ stats.unsynced }}
                {% if showing_count > 0 %}
                | Showing {{ showing_start }}-{{ showing_end }} of {{ total_words }}
                {% endif %}
            </div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">üåô Dark Mode</button>
    </header>

    <div class="search-sort-wrapper">
        <form method="GET" action="/" class="search-box">
            <input
                type="text"
                name="q"
                placeholder="Search for Dutch words, translations, or definitions..."
                value="{{ query or '' }}"
            >
            <button type="submit">Search</button>
        </form>

        <div class="sort-controls">
            <label>Sort by:</label>
            <select id="sort-by" onchange="updateSort()">
                <option value="dutch" {% if sort_by == 'dutch' %}selected{% endif %}>Dutch</option>
                <option value="translation" {% if sort_by == 'translation' %}selected{% endif %}>Translation</option>
                <option value="grammar" {% if sort_by == 'grammar' %}selected{% endif %}>Grammar</option>
            </select>

            <label>Order:</label>
            <select id="order" onchange="updateSort()">
                <option value="asc" {% if order == 'asc' %}selected{% endif %}>Ascending</option>
                <option value="desc" {% if order == 'desc' %}selected{% endif %}>Descending</option>
            </select>
        </div>
    </div>

    {% if words_data %}
    <!-- Pagination Top (only show from page 2 onwards) -->
    {% if total_pages > 1 and page > 1 %}
    <div class="pagination-container">
        <div class="pagination">
            {% if page > 1 %}
                <a href="?{{ get_pagination_url(page - 1, query, sort_by, order) }}" class="pagination-btn">‚Üê Prev</a>
            {% else %}
                <span class="pagination-btn disabled">‚Üê Prev</span>
            {% endif %}

            {% for p in page_range %}
                {% if p == '...' %}
                    <span class="pagination-ellipsis">...</span>
                {% elif p == page %}
                    <span class="pagination-btn active">{{ p }}</span>
                {% else %}
                    <a href="?{{ get_pagination_url(p, query, sort_by, order) }}" class="pagination-btn">{{ p }}</a>
                {% endif %}
            {% endfor %}

            {% if page < total_pages %}
                <a href="?{{ get_pagination_url(page + 1, query, sort_by, order) }}" class="pagination-btn">Next ‚Üí</a>
            {% else %}
                <span class="pagination-btn disabled">Next ‚Üí</span>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="word-list">
        {% for word, updated_at in words_data %}
        <div class="word-card">
            <div class="word-summary" onclick="toggleDetails(this)">
                <div class="word-dutch">
                    {{ word.dutch }}
                    <div style="font-size: 11px; color: var(--text-dim); font-weight: normal; margin-top: 2px;">
                        {{ updated_at[:10] if updated_at else '' }}
                    </div>
                </div>
                <div class="word-translation">{{ word.translation }}</div>
                <div class="word-grammar-pronunciation">
                    <div class="word-grammar">{{ word.grammar[:60] }}{% if word.grammar|length > 60 %}...{% endif %}</div>
                    <div class="word-pronunciation">{{ word.pronunciation }}</div>
                </div>
                <div class="word-preview">{{ word.definition_nl[:80] }}...</div>
            </div>

            <div class="word-details">
                <div class="word-section">
                    <div class="word-label">Grammar</div>
                    <div class="word-content">{{ word.grammar }}</div>
                </div>

                <div class="word-section">
                    <div class="word-label">Definition (NL)</div>
                    <div class="word-content">{{ word.definition_nl }}</div>
                </div>

                <div class="word-section">
                    <div class="word-label">Definition (EN)</div>
                    <div class="word-content">{{ word.definition_en }}</div>
                </div>

                {% if word.collocations %}
                <div class="word-section">
                    <div class="word-label">Collocations</div>
                    <div class="word-list-inline">{{ word.collocations | join(', ') }}</div>
                </div>
                {% endif %}

                {% if word.synonyms %}
                <div class="word-section">
                    <div class="word-label">Synonyms</div>
                    <div class="word-list-inline">{{ word.synonyms | join(', ') }}</div>
                </div>
                {% endif %}

                {% if word.related %}
                <div class="word-section">
                    <div class="word-label">Related Words</div>
                    <div class="word-list-inline">{{ word.related | join(', ') }}</div>
                </div>
                {% endif %}

                {% if word.examples_nl %}
                <div class="word-section">
                    <div class="word-label">Examples</div>
                    <div class="examples">
                        {% for nl, en in zip(word.examples_nl, word.examples_en) %}
                        <div class="example-item">
                            <div class="example-nl">{{ nl }}</div>
                            <div class="example-en">{{ en }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if word.etymology %}
                <div class="word-section">
                    <div class="word-label">Etymology</div>
                    <div class="word-content">{{ word.etymology }}</div>
                </div>
                {% endif %}

                <div class="word-actions">
                    <a href="/edit/{{ word.dutch | urlencode }}" class="btn btn-edit" onclick="event.stopPropagation()">Edit</a>
                    <button class="btn btn-delete" onclick="event.stopPropagation(); deleteWord('{{ word.dutch | replace("'", "\\'") }}', this.closest('.word-card'))">Delete</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination Bottom -->
    {% if total_pages > 1 %}
    <div class="pagination bottom">
        {% if page > 1 %}
            <a href="?{{ get_pagination_url(page - 1, query, sort_by, order) }}" class="pagination-btn">‚Üê Prev</a>
        {% else %}
            <span class="pagination-btn disabled">‚Üê Prev</span>
        {% endif %}

        {% for p in page_range %}
            {% if p == '...' %}
                <span class="pagination-ellipsis">...</span>
            {% elif p == page %}
                <span class="pagination-btn active">{{ p }}</span>
            {% else %}
                <a href="?{{ get_pagination_url(p, query, sort_by, order) }}" class="pagination-btn">{{ p }}</a>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
            <a href="?{{ get_pagination_url(page + 1, query, sort_by, order) }}" class="pagination-btn">Next ‚Üí</a>
        {% else %}
            <span class="pagination-btn disabled">Next ‚Üí</span>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="no-results">
        {% if query %}
            No words found for "{{ query }}"
        {% else %}
            No words in database yet. Add some words using the CLI!
        {% endif %}
    </div>
    {% endif %}

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        function updateSort() {
            const sortBy = document.getElementById('sort-by').value;
            const order = document.getElementById('order').value;
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('sort', sortBy);
            urlParams.set('order', order);
            urlParams.delete('page');  // Reset to page 1 when sorting changes
            window.location.search = urlParams.toString();
        }
    </script>
</body>
</html>
